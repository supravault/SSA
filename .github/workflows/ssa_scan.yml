name: SSA Scan

on:
  workflow_dispatch:
    inputs:
      scanner_type:
        description: "wallet | coin | fa"
        required: true
        type: string
      target:
        description: "wallet address (0x...) OR coin type (0xADDR::MODULE::COIN) OR FA address (0x...)"
        required: true
        type: string
      level:
        description: "wallet: 1-3, coin/fa: 1-5"
        required: true
        type: string
      project_name:
        description: "Project name (folder under reports/)"
        required: true
        type: string
      project_label:
        description: "Optional label (stored in inputs.json + affects output folder name)"
        required: false
        type: string

jobs:
  scan:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    # Avoid overlapping commits for the same project
    concurrency:
      group: ssa-scan-${{ github.event.inputs.project_name }}
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install
        run: npm ci

      - name: Build
        run: npm run build

      # Helpful when the CLI path breaks again; safe to keep
      - name: Debug dist output
        shell: bash
        run: |
          set -euo pipefail
          echo "==== dist tree (top 200 files) ===="
          if [ -d dist ]; then
            find dist -type f | head -n 200
          else
            echo "dist/ does not exist after build!"
          fi

      - name: Run SSA Scan
        shell: bash
        env:
          SUPRA_RPC_URL: ${{ secrets.SUPRA_RPC_URL }}
          SCANNER_TYPE: ${{ github.event.inputs.scanner_type }}
          TARGET: ${{ github.event.inputs.target }}
          LEVEL: ${{ github.event.inputs.level }}
          PROJECT_NAME: ${{ github.event.inputs.project_name }}
          PROJECT_LABEL: ${{ github.event.inputs.project_label }}
        run: |
          set -euo pipefail

          # --- Basic validation / normalization ---
          kind="$(echo "${SCANNER_TYPE}" | tr '[:upper:]' '[:lower:]' | xargs)"
          level="$(echo "${LEVEL}" | xargs)"
          target="$(echo "${TARGET}" | xargs)"
          project="$(echo "${PROJECT_NAME}" | xargs)"
          label="$(echo "${PROJECT_LABEL:-}" | xargs)"

          if [[ ! "$kind" =~ ^(wallet|coin|fa)$ ]]; then
            echo "❌ scanner_type must be one of: wallet | coin | fa"
            exit 1
          fi

          # project folder safety: only allow alnum, dash, underscore, dot
          if [[ ! "$project" =~ ^[a-zA-Z0-9._-]+$ ]]; then
            echo "❌ project_name contains invalid characters. Allowed: letters, numbers, . _ -"
            exit 1
          fi

          # timestamped output folder under reports/
          ts="$(date -u +'%Y%m%dT%H%M%SZ')"
          safe_label=""
          if [[ -n "$label" ]]; then
            # label safety for folder suffix
            safe_label="$(echo "$label" | tr -cd 'a-zA-Z0-9._-')"
          fi

          if [[ -n "$safe_label" ]]; then
            out_dir="reports/${project}/${ts}_${kind}_L${level}_${safe_label}"
          else
            out_dir="reports/${project}/${ts}_${kind}_L${level}"
          fi

          mkdir -p "$out_dir"

          # Persist dispatch inputs for Base44 ingestion / auditability
          cat > "${out_dir}/inputs.json" <<EOF
          {
            "run_id": "${{ github.run_id }}",
            "run_attempt": "${{ github.run_attempt }}",
            "workflow": "${{ github.workflow }}",
            "repo": "${{ github.repository }}",
            "ref": "${{ github.ref }}",
            "sha": "${{ github.sha }}",
            "triggered_by": "${{ github.actor }}",
            "ts_utc": "${ts}",
            "kind": "${kind}",
            "level": ${level},
            "target": "${target}",
            "project_name": "${project}",
            "project_label": "${label}",
            "rpc": "${SUPRA_RPC_URL}"
          }
          EOF

          # --- Build the correct target flag for the CLI ---
          # NOTE: SSA CLI uses:
          #  - --coinType for kind=coin
          #  - --fa for kind=fa
          #  - --address for kind=wallet
          target_args=()
          if [[ "$kind" == "coin" ]]; then
            target_args=( --coinType "$target" )
          elif [[ "$kind" == "fa" ]]; then
            target_args=( --fa "$target" )
          else
            target_args=( --address "$target" )
          fi

          # --- Resolve the actual compiled CLI path (robust across tsconfig changes) ---
          CLI=""
          if [ -f dist/cli/ssa.js ]; then
            CLI="dist/cli/ssa.js"
          elif [ -f dist/src/cli/ssa.js ]; then
            CLI="dist/src/cli/ssa.js"
          elif [ -f dist/cli/index.js ]; then
            CLI="dist/cli/index.js"
          else
            echo "❌ SSA CLI not found after build."
            echo "Searched:"
            echo "  - dist/cli/ssa.js"
            echo "  - dist/src/cli/ssa.js"
            echo "  - dist/cli/index.js"
            echo ""
            echo "Available dist files (top 200):"
            if [ -d dist ]; then
              find dist -type f | head -n 200
            fi
            exit 1
          fi

          echo "▶ Running scan: kind=${kind}, level=${level}, out=${out_dir}, cli=${CLI}"
          node "$CLI" scan \
            --kind "$kind" \
            --level "$level" \
            "${target_args[@]}" \
            --rpc "$SUPRA_RPC_URL" \
            --out "$out_dir" \
            --pdf

      - name: Upload artifacts (optional but useful for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: ssa-${{ github.event.inputs.project_name }}-${{ github.run_id }}
          path: reports/${{ github.event.inputs.project_name }}/
          if-no-files-found: error
          retention-days: 7

      - name: Commit & Push
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "ssa-bot"
          git config user.email "ssa-bot@users.noreply.github.com"

          git add reports/"${{ github.event.inputs.project_name }}"/

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "SSA: ${{ github.event.inputs.project_name }} ${{ github.event.inputs.scanner_type }} L${{ github.event.inputs.level }} (run ${{ github.run_id }})"
          git push


