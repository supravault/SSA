name: SSA Bundle Scan

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: "Project name (folder under reports/)"
        required: true
        type: string
      project_label:
        description: "Optional label (affects output folder name)"
        required: false
        type: string
      bundle_json:
        description: >
          JSON describing scans. Accepts either:
          1) Array: [{"kind":"wallet","level":3,"target":"0x..."}, {"kind":"fa","level":2,"target":"0x..."}]
          2) Object: {"scans":[...]}
        required: true
        type: string
      dispatch_id:
        description: "Optional: Base44 dispatch UUID (used to correlate ingestion)"
        required: false
        type: string
      pulse_url:
        description: "Optional: URL to Supra Pulse PDF/JSON (Base44 hosted URL or direct)"
        required: false
        type: string
      pulse_tier:
        description: "Optional: Standard | Premium | Spotlight (used for bundle branding)"
        required: false
        type: string
      pulse_project:
        description: "Optional: Supra Pulse project name (display only)"
        required: false
        type: string
      pulse_score:
        description: "Optional: Pulse score (0-100). If provided, overrides parsing."
        required: false
        type: string
      pulse_verdict:
        description: "Optional: Pulse verdict (SAFE/LOW/MEDIUM/HIGH/CRITICAL/OK). If provided, overrides parsing."
        required: false
        type: string
      pulse_timestamp:
        description: "Optional: Pulse timestamp UTC (e.g., 2026-01-11T05:50:36Z). If provided, overrides parsing."
        required: false
        type: string

  # Optional â€œcontinuous monitoringâ€ runner (FA L5):
  # - Add a repo file: config/continuous_watch.json
  schedule:
    - cron: "0 3 * * *"

jobs:
  bundle_scan:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    concurrency:
      group: ssa-bundle-${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install (npm)
        run: npm install

      - name: Build
        run: npm run build

      - name: Ensure system tools (jq, qpdf, poppler-utils, python3)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq qpdf poppler-utils python3
          jq --version
          qpdf --version || true
          pdftotext -v || true
          python3 --version

      - name: Resolve inputs + prepare bundle directory
        shell: bash
        env:
          SUPRA_RPC_URL: ${{ secrets.SUPRA_RPC_URL }}

          PROJECT_NAME: ${{ github.event.inputs.project_name }}
          PROJECT_LABEL: ${{ github.event.inputs.project_label }}
          BUNDLE_JSON: ${{ github.event.inputs.bundle_json }}
          DISPATCH_ID: ${{ github.event.inputs.dispatch_id }}

          PULSE_URL: ${{ github.event.inputs.pulse_url }}
          PULSE_TIER: ${{ github.event.inputs.pulse_tier }}
          PULSE_PROJECT: ${{ github.event.inputs.pulse_project }}
          PULSE_SCORE: ${{ github.event.inputs.pulse_score }}
          PULSE_VERDICT: ${{ github.event.inputs.pulse_verdict }}
          PULSE_TIMESTAMP: ${{ github.event.inputs.pulse_timestamp }}

          RUN_ID: ${{ github.run_id }}
          RUN_ATTEMPT: ${{ github.run_attempt }}
          WORKFLOW_NAME: ${{ github.workflow }}
          REPO: ${{ github.repository }}
          REF: ${{ github.ref }}
          SHA: ${{ github.sha }}
          ACTOR: ${{ github.actor }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          set -euo pipefail

          if [[ -z "${SUPRA_RPC_URL:-}" ]]; then
            echo "âŒ SUPRA_RPC_URL secret is missing or empty."
            exit 1
          fi

          project="$(echo "${PROJECT_NAME:-}" | xargs || true)"
          label="$(echo "${PROJECT_LABEL:-}" | xargs || true)"
          dispatch_id="$(echo "${DISPATCH_ID:-}" | xargs || true)"
          bundle_json_raw="${BUNDLE_JSON:-}"

          pulse_url="$(echo "${PULSE_URL:-}" | xargs || true)"
          pulse_tier="$(echo "${PULSE_TIER:-}" | xargs || true)"
          pulse_project="$(echo "${PULSE_PROJECT:-}" | xargs || true)"
          pulse_score="$(echo "${PULSE_SCORE:-}" | xargs || true)"
          pulse_verdict="$(echo "${PULSE_VERDICT:-}" | xargs || true)"
          pulse_timestamp="$(echo "${PULSE_TIMESTAMP:-}" | xargs || true)"

          if [[ "${EVENT_NAME:-}" == "schedule" ]]; then
            if [[ -f "config/continuous_watch.json" ]]; then
              echo "ðŸ•’ schedule trigger: loading config/continuous_watch.json"
              project="$(jq -r '.project_name // "CONTINUOUS"' config/continuous_watch.json | xargs)"
              label="$(jq -r '.project_label // ""' config/continuous_watch.json | xargs)"
              bundle_json_raw="$(jq -c '.bundle_json // {}' config/continuous_watch.json)"
              pulse_url="$(jq -r '.pulse_url // ""' config/continuous_watch.json | xargs)"
              pulse_tier="$(jq -r '.pulse_tier // ""' config/continuous_watch.json | xargs)"
              pulse_project="$(jq -r '.pulse_project // ""' config/continuous_watch.json | xargs)"
              pulse_score="$(jq -r '.pulse_score // ""' config/continuous_watch.json | xargs)"
              pulse_verdict="$(jq -r '.pulse_verdict // ""' config/continuous_watch.json | xargs)"
              pulse_timestamp="$(jq -r '.pulse_timestamp // ""' config/continuous_watch.json | xargs)"
              dispatch_id="$(jq -r '.dispatch_id // ""' config/continuous_watch.json | xargs)"
            else
              echo "â„¹ï¸ schedule trigger but config/continuous_watch.json not found; exiting cleanly."
              exit 0
            fi
          fi

          if [[ -z "${project:-}" ]]; then
            echo "âŒ project_name is required."
            exit 1
          fi

          if [[ ! "$project" =~ ^[a-zA-Z0-9._-]+$ ]]; then
            echo "âŒ project_name contains invalid characters. Allowed: letters, numbers, . _ -"
            exit 1
          fi

          safe_label=""
          if [[ -n "${label:-}" ]]; then
            safe_label="$(echo "$label" | tr -cd 'a-zA-Z0-9._-')"
          fi

          if [[ -n "$safe_label" ]]; then
            bundle_dir="reports/${project}/${RUN_ID}_BUNDLE_${safe_label}"
          else
            bundle_dir="reports/${project}/${RUN_ID}_BUNDLE"
          fi

          mkdir -p "$bundle_dir/scans" "$bundle_dir/tmp"
          echo "$bundle_dir" > "$GITHUB_WORKSPACE/.bundle_dir"
          printf '%s' "$bundle_json_raw" > "$bundle_dir/tmp/_bundle_input.json"

          # store pulse fields for later steps
          printf '%s' "${pulse_url:-}" > "$GITHUB_WORKSPACE/.pulse_url"
          printf '%s' "${pulse_tier:-}" > "$GITHUB_WORKSPACE/.pulse_tier"
          printf '%s' "${pulse_project:-}" > "$GITHUB_WORKSPACE/.pulse_project"
          printf '%s' "${pulse_score:-}" > "$GITHUB_WORKSPACE/.pulse_score"
          printf '%s' "${pulse_verdict:-}" > "$GITHUB_WORKSPACE/.pulse_verdict"
          printf '%s' "${pulse_timestamp:-}" > "$GITHUB_WORKSPACE/.pulse_timestamp"
          printf '%s' "${dispatch_id:-}" > "$GITHUB_WORKSPACE/.dispatch_id"

      - name: Normalize bundle_json -> bundle_scans.json
        shell: bash
        run: |
          set -euo pipefail
          bundle_dir="$(cat .bundle_dir)"
          in_json="$bundle_dir/tmp/_bundle_input.json"
          out_json="$bundle_dir/bundle_scans.json"
          tmp_norm="$bundle_dir/tmp/_bundle_norm.json"

          jq -e '
            def as_str: (if . == null then "" else tostring end);

            def allowlist:
              (.modulesAllowlist // "")
              | if type=="array" then map(tostring) | join(",")
                elif type=="string" then .
                else "" end;

            def norm:
              {
                kind: ((.kind // "" | as_str) | ascii_downcase | gsub("[[:space:]]+";"")),
                level: (.level | tonumber),
                target: ((.target // "" | as_str) | gsub("^[[:space:]]+|[[:space:]]+$";"")),
                modulesAllowlist: allowlist
              };

            def scans:
              if type=="array" then .
              elif (type=="object" and (.scans|type)=="array") then .scans
              else error("bundle_json must be array or {scans:[...]}") end;

            scans as $s
            | if ($s|length)==0 then error("bundle_json has zero scans") else . end
            | { scans: [ $s[] | norm ] }
          ' "$in_json" > "$tmp_norm"

          jq -e '
            .scans as $n
            | ($n|length) as $len
            | if $len == 0 then error("bundle_json has zero scans") else . end
            | ($n|to_entries|map(
                .key as $i
                | .value as $v
                | if (["wallet","coin","fa"]|index($v.kind))==null then error("scan["+($i|tostring)+"].kind must be wallet|coin|fa") else . end
                | if ($v.level < 1 or $v.level > 5) then error("scan["+($i|tostring)+"].level must be 1..5") else . end
                | if ($v.kind=="wallet" and ($v.level < 1 or $v.level > 3)) then error("scan["+($i|tostring)+"].wallet level must be 1..3") else . end
                | if (($v.target|tostring)|length)==0 then error("scan["+($i|tostring)+"].target is required") else . end
              )) | length
          ' "$tmp_norm" > /dev/null

          mv "$tmp_norm" "$out_json"
          echo "âœ… Wrote bundle_scans.json: $out_json"

      - name: Download Pulse (best effort)
        shell: bash
        run: |
          set -euo pipefail
          bundle_dir="$(cat .bundle_dir)"
          pulse_url="$(cat .pulse_url || true)"

          pulse_path=""
          pulse_error=""

          if [[ -n "${pulse_url:-}" ]]; then
            echo "â¬‡ï¸ Downloading Supra Pulse report..."
            url_no_q="${pulse_url%%\?*}"
            ext="${url_no_q##*.}"
            ext="$(echo "$ext" | tr "[:upper:]" "[:lower:]")"
            if [[ "$ext" =~ ^(pdf|json)$ ]]; then
              pulse_path="$bundle_dir/tmp/pulse_input.${ext}"
            else
              pulse_path="$bundle_dir/tmp/pulse_input.pdf"
            fi

            set +e
            http_code="$(curl -L -sS -w "%{http_code}" -o "$pulse_path" "$pulse_url")"
            curl_rc=$?
            set -e

            if [[ $curl_rc -ne 0 || "$http_code" -lt 200 || "$http_code" -ge 300 ]]; then
              echo "âš ï¸ Pulse download failed (rc=$curl_rc http=$http_code). Continuing without pulse."
              rm -f "$pulse_path" || true
              pulse_path=""
              pulse_error="pulse_download_failed_rc_${curl_rc}_http_${http_code}"
            else
              echo "âœ… Pulse saved: $pulse_path"
            fi
          fi

          printf '%s' "${pulse_path:-}" > .pulse_path
          printf '%s' "${pulse_error:-}" > .pulse_error

      - name: Run bundle scans + merge PDFs
        shell: bash
        env:
          SUPRA_RPC_URL: ${{ secrets.SUPRA_RPC_URL }}
          RUN_ID: ${{ github.run_id }}
          RUN_ATTEMPT: ${{ github.run_attempt }}
          WORKFLOW_NAME: ${{ github.workflow }}
          REPO: ${{ github.repository }}
          REF: ${{ github.ref }}
          SHA: ${{ github.sha }}
          ACTOR: ${{ github.actor }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          set -euo pipefail
          bundle_dir="$(cat .bundle_dir)"
          pulse_path="$(cat .pulse_path || true)"

          # Resolve compiled SSA CLI path
          CLI=""
          if [[ -f dist/cli/ssa.js ]]; then
            CLI="dist/cli/ssa.js"
          elif [[ -f dist/src/cli/ssa.js ]]; then
            CLI="dist/src/cli/ssa.js"
          else
            echo "âŒ SSA CLI not found after build."
            echo "Searched: dist/cli/ssa.js, dist/src/cli/ssa.js"
            (find dist -type f -print | head -n 200) || true
            exit 1
          fi
          echo "âœ… Using CLI: $CLI"

          # Resolve report generator (optional)
          GEN=""
          if [[ -f dist/scripts/generate-report.js ]]; then
            GEN="dist/scripts/generate-report.js"
          elif [[ -f dist/src/scripts/generate-report.js ]]; then
            GEN="dist/src/scripts/generate-report.js"
          fi
          if [[ -n "$GEN" ]]; then
            echo "âœ… Using generator: $GEN"
          else
            echo "âš ï¸ generate-report.js not found in dist/. final_report.pdf will be skipped."
          fi
          printf '%s' "$GEN" > .gen_path

          # Fix SVG path mismatch in Actions by ensuring ../tools/icons exists
          parent_dir="$(cd "$GITHUB_WORKSPACE/.." && pwd)"
          mkdir -p "$parent_dir/tools"
          if [[ ! -e "$parent_dir/tools/icons" ]]; then
            ln -s "$GITHUB_WORKSPACE/tools/icons" "$parent_dir/tools/icons"
          fi

          : > "$bundle_dir/tmp/pdfs.txt"
          total="$(jq -r ".scans | length" "$bundle_dir/bundle_scans.json")"
          echo "â–¶ Running bundle scans: $total scan(s)"

          for idx in $(seq 0 $((total-1))); do
            kind="$(jq -r ".scans[$idx].kind" "$bundle_dir/bundle_scans.json")"
            level="$(jq -r ".scans[$idx].level" "$bundle_dir/bundle_scans.json")"
            target="$(jq -r ".scans[$idx].target" "$bundle_dir/bundle_scans.json")"
            allowlist="$(jq -r ".scans[$idx].modulesAllowlist // \"\"" "$bundle_dir/bundle_scans.json")"

            scan_dir="$bundle_dir/scans/${idx}_${kind}_L${level}"
            mkdir -p "$scan_dir"

            jq -n \
              --arg kind "$kind" \
              --arg target "$target" \
              --arg rpc "$SUPRA_RPC_URL" \
              --arg pulseTier "$(cat .pulse_tier || true)" \
              --arg allowlist "$allowlist" \
              --argjson level "$level" \
              --argjson pulseAttached "$( [[ -n "$pulse_path" ]] && echo true || echo false )" \
              '{
                kind: $kind,
                level: $level,
                target: $target,
                wallet_modules_allowlist: $allowlist,
                rpc: $rpc,
                pulse_attached: $pulseAttached,
                pulse_tier: $pulseTier
              }' > "$scan_dir/scan_inputs.json"

            target_args=()
            if [[ "$kind" == "coin" ]]; then
              target_args=( --coinType "$target" )
            elif [[ "$kind" == "fa" ]]; then
              target_args=( --fa "$target" )
            else
              target_args=( --address "$target" )
            fi

            pulse_args=()
            if [[ -n "$pulse_path" ]]; then
              pulse_args=( --pulse "$pulse_path" )
            fi

            echo "â–¶ [$((idx+1))/$total] ${kind} L${level} ${target}"
            node "$CLI" scan \
              --kind "$kind" \
              --level "$level" \
              "${target_args[@]}" \
              --rpc "$SUPRA_RPC_URL" \
              --out "$scan_dir" \
              --pdf \
              "${pulse_args[@]}"

            if [[ ! -f "$scan_dir/report.pdf" ]]; then
              echo "âŒ Missing expected PDF: $scan_dir/report.pdf"
              exit 1
            fi

            mv "$scan_dir/report.pdf" "$scan_dir/${kind}_report.pdf"
            echo "$scan_dir/${kind}_report.pdf" >> "$bundle_dir/tmp/pdfs.txt"

            if [[ "$kind" == "fa" && "$level" == "5" && -f "$scan_dir/report.json" ]]; then
              tmp_report="$scan_dir/tmp_report.json"
              jq '
                .monitoring = {
                  enabled: true,
                  mode: "continuous",
                  cadence: "24h",
                  next_run_hint_utc: null,
                  note: "L5 implies continuous monitoring. Schedule runs are implemented via workflow schedule + config/continuous_watch.json."
                }
              ' "$scan_dir/report.json" > "$tmp_report" && mv "$tmp_report" "$scan_dir/report.json"
              echo "âœ… Patched FA L5 report.json with monitoring.enabled=true"
            fi
          done

          echo "ðŸ§© Building combined_report.pdf (qpdf)..."
          combined="$bundle_dir/combined_report.pdf"
          mapfile -t pdfs < "$bundle_dir/tmp/pdfs.txt"
          qpdf --empty --pages "${pdfs[@]}" -- "$combined"
          echo "âœ… Combined PDF: $combined"

      - name: Build pulse_summary.json (best effort)
        shell: bash
        run: |
          set -euo pipefail
          bundle_dir="$(cat .bundle_dir)"
          pulse_path="$(cat .pulse_path || true)"

          pulse_tier="$(cat .pulse_tier || true)"
          pulse_project="$(cat .pulse_project || true)"
          pulse_score="$(cat .pulse_score || true)"
          pulse_verdict="$(cat .pulse_verdict || true)"
          pulse_timestamp="$(cat .pulse_timestamp || true)"

          pulse_summary_path=""
          if [[ -n "${pulse_tier:-}" || -n "${pulse_path:-}" ]]; then
            pulse_summary_path="$bundle_dir/tmp/pulse_summary.json"

            export PULSE_TIER="$pulse_tier"
            export PULSE_PROJECT="$pulse_project"
            export PULSE_SCORE="$pulse_score"
            export PULSE_VERDICT="$pulse_verdict"
            export PULSE_TIMESTAMP="$pulse_timestamp"
            export PULSE_PATH="$pulse_path"
            export BUNDLE_DIR="$bundle_dir"

            python3 -c "import os,re,json,subprocess
tier=(os.environ.get('PULSE_TIER') or 'Standard').strip() or 'Standard'
project=(os.environ.get('PULSE_PROJECT') or '').strip()
score_in=(os.environ.get('PULSE_SCORE') or '').strip()
verdict_in=(os.environ.get('PULSE_VERDICT') or '').strip()
ts_in=(os.environ.get('PULSE_TIMESTAMP') or '').strip()
pulse_path=(os.environ.get('PULSE_PATH') or '').strip()
bundle_dir=os.environ.get('BUNDLE_DIR') or ''
txt_out_a=os.path.join(bundle_dir,'tmp','pulse_layout.txt')
txt_out_b=os.path.join(bundle_dir,'tmp','pulse_raw.txt')

def clamp_score(x):
  try:
    v=int(str(x).strip()); return v if 0<=v<=100 else None
  except Exception: return None

def verdict_from_score(score):
  if score is None: return ''
  return 'SAFE' if score>=80 else 'LOW' if score>=60 else 'MEDIUM' if score>=40 else 'HIGH' if score>=20 else 'CRITICAL'

score=clamp_score(score_in) if score_in else None
verdict=verdict_in.upper().strip() if verdict_in else ''
timestamp_utc=ts_in.strip() if ts_in else ''
source='workflow_inputs' if (score_in or verdict_in or ts_in) else ''
raw_obj=None

def pull(d):
  global score,verdict,timestamp_utc
  if not isinstance(d,dict): return
  for k in ['score','risk_score','riskScore','total_score','overall_score','overallScore']:
    if score is None and k in d: score=clamp_score(d.get(k))
  for k in ['verdict','risk','status','risk_level','riskLevel','rating']:
    if not verdict and k in d:
      vv=str(d.get(k) or '').strip()
      if vv: verdict=vv.upper()
  for k in ['timestamp','timestamp_utc','ts','date','generated_at','generatedAt']:
    if not timestamp_utc and k in d: timestamp_utc=str(d.get(k) or '').strip()

if (not source) and pulse_path.lower().endswith('.json') and os.path.exists(pulse_path):
  try:
    raw_obj=json.load(open(pulse_path,'r',encoding='utf-8',errors='ignore')); source='pulse_json'; pull(raw_obj)
  except Exception:
    raw_obj=None; source=''

if (not source) and pulse_path.lower().endswith('.pdf') and os.path.exists(pulse_path):
  try:
    subprocess.run(['pdftotext','-layout',pulse_path,txt_out_a],check=False,stdout=subprocess.DEVNULL,stderr=subprocess.DEVNULL)
    subprocess.run(['pdftotext','-raw',pulse_path,txt_out_b],check=False,stdout=subprocess.DEVNULL,stderr=subprocess.DEVNULL)
    def read(p):
      try: return open(p,'r',encoding='utf-8',errors='ignore').read()
      except Exception: return ''
    raw_a=read(txt_out_a); raw_b=read(txt_out_b); raw=raw_a if len(raw_a)>=len(raw_b) else raw_b
    source='pulse_pdf_text_extract'
    if not timestamp_utc:
      m=re.search(r'\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z',raw)
      if m: timestamp_utc=m.group(0)
    if score is None:
      for pat in [r'\\b(?:overall\\s+)?score\\b[^0-9]{0,120}(\\d{1,3})\\b',r'\\brisk\\s*score\\b[^0-9]{0,120}(\\d{1,3})\\b',r'(\\d{1,3})\\s*/\\s*100']:
        mm=re.search(pat,raw,re.I)
        if mm:
          score=clamp_score(mm.group(1))
          if score is not None: break
    if not verdict:
      m=re.search(r'\\b(verdict|risk\\s*level|risk)\\b[^A-Z]{0,140}\\b(SAFE|OK|LOW|MEDIUM|HIGH|CRITICAL|WARNING)\\b',raw,re.I)
      if m: verdict=m.group(2).upper().strip()
      else:
        m2=re.search(r'\\b(SAFE|OK|LOW|MEDIUM|HIGH|CRITICAL|WARNING)\\b',raw,re.I)
        if m2: verdict=m2.group(1).upper().strip()
  except Exception:
    source=''

if not verdict:
  verdict=verdict_from_score(score) or 'UNKNOWN'

out={'tier':tier,'project':project,'timestamp_utc':timestamp_utc,'score':score,'verdict':verdict,'source':(source if source else 'missing_pulse')}
if raw_obj is not None: out['raw']=raw_obj
print(json.dumps(out,indent=2))" > "$pulse_summary_path"

            echo "âœ… pulse_summary.json ready: $pulse_summary_path"
          fi

          printf '%s' "${pulse_summary_path:-}" > .pulse_summary_path

      - name: Generate final_report.pdf (if generator + pulse summary exist)
        shell: bash
        run: |
          set -euo pipefail
          bundle_dir="$(cat .bundle_dir)"
          GEN="$(cat .gen_path || true)"
          pulse_summary_path="$(cat .pulse_summary_path || true)"

          if [[ -n "${GEN:-}" && -n "${pulse_summary_path:-}" ]]; then
            echo "ðŸ§© Installing Playwright browser (chromium) for final report..."
            export PLAYWRIGHT_BROWSERS_PATH=0
            npx playwright install --with-deps chromium

            echo "ðŸ Generating final_report.pdf via generate-report.js..."
            ts_utc="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"

            primary_scan="$(ls -1 "$bundle_dir"/scans/*_coin_L*/report.json 2>/dev/null | head -n 1 || true)"
            if [[ -z "$primary_scan" ]]; then primary_scan="$(ls -1 "$bundle_dir"/scans/*_fa_L*/report.json 2>/dev/null | head -n 1 || true)"; fi
            if [[ -z "$primary_scan" ]]; then primary_scan="$(ls -1 "$bundle_dir"/scans/*_wallet_L*/report.json 2>/dev/null | head -n 1 || true)"; fi

            wallet_scan="$(ls -1 "$bundle_dir"/scans/*_wallet_L*/report.json 2>/dev/null | head -n 1 || true)"
            fa_scan="$(ls -1 "$bundle_dir"/scans/*_fa_L*/report.json 2>/dev/null | head -n 1 || true)"

            if [[ -n "$primary_scan" ]]; then
              outdir="$bundle_dir/tmp/_gen"
              mkdir -p "$outdir"

              args=( --scan "$primary_scan" --pulse "$pulse_summary_path" --project-name "$(basename "$(dirname "$bundle_dir")")" --ts-utc "$ts_utc" --out "$outdir" )
              if [[ -n "$wallet_scan" && "$wallet_scan" != "$primary_scan" ]]; then args+=( --wallet-scan "$wallet_scan" ); fi
              if [[ -n "$fa_scan" && "$fa_scan" != "$primary_scan" ]]; then args+=( --fa "$fa_scan" ); fi

              node "$GEN" "${args[@]}"

              newest_final="$(find "$outdir" -name final_report.pdf -print | sort | tail -n 1 || true)"
              if [[ -n "$newest_final" ]]; then
                cp -f "$newest_final" "$bundle_dir/final_report.pdf"
                echo "âœ… final_report.pdf ready: $bundle_dir/final_report.pdf"
              else
                echo "âš ï¸ generate-report ran but final_report.pdf not found under $outdir"
              fi
            else
              echo "âš ï¸ No scan report.json found; skipping final integrated report."
            fi
          else
            echo "â„¹ï¸ Skipping final_report.pdf generation (missing generator or pulse summary)."
          fi

      - name: Write bundle_inputs.json (Base44 correlation)
        shell: bash
        env:
          SUPRA_RPC_URL: ${{ secrets.SUPRA_RPC_URL }}
          RUN_ID: ${{ github.run_id }}
          RUN_ATTEMPT: ${{ github.run_attempt }}
          WORKFLOW_NAME: ${{ github.workflow }}
          REPO: ${{ github.repository }}
          REF: ${{ github.ref }}
          SHA: ${{ github.sha }}
          ACTOR: ${{ github.actor }}
        run: |
          set -euo pipefail
          bundle_dir="$(cat .bundle_dir)"
          dispatch_id="$(cat .dispatch_id || true)"

          pulse_url="$(cat .pulse_url || true)"
          pulse_tier="$(cat .pulse_tier || true)"
          pulse_error="$(cat .pulse_error || true)"
          pulse_path="$(cat .pulse_path || true)"

          tier_lc="$(echo "${pulse_tier:-}" | tr "[:upper:]" "[:lower:]" | xargs)"
          report_type="SSA_REPORT"
          if [[ "$tier_lc" == "premium" || "$tier_lc" == "spotlight" ]]; then
            report_type="SSA_FULL_INTEGRATED_REPORT"
          fi

          ts_utc="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          pulse_attached="false"
          if [[ -n "$pulse_path" ]]; then pulse_attached="true"; fi

          project_name="$(basename "$(dirname "$bundle_dir")")"
          project_label="$(basename "$bundle_dir" | sed -n 's/.*_BUNDLE_//p')"

          jq -n \
            --arg dispatch_id "$dispatch_id" \
            --arg run_id "$RUN_ID" \
            --arg run_attempt "$RUN_ATTEMPT" \
            --arg workflow "$WORKFLOW_NAME" \
            --arg repo "$REPO" \
            --arg ref "$REF" \
            --arg sha "$SHA" \
            --arg triggered_by "$ACTOR" \
            --arg ts_utc "$ts_utc" \
            --arg project_name "$project_name" \
            --arg project_label "${project_label:-}" \
            --arg rpc "$SUPRA_RPC_URL" \
            --arg report_type "$report_type" \
            --arg pulse_attached "$pulse_attached" \
            --arg pulse_tier "${pulse_tier:-}" \
            --arg pulse_url "${pulse_url:-}" \
            --arg pulse_error "${pulse_error:-}" \
            --slurpfile bundle "$bundle_dir/bundle_scans.json" \
            '{
              dispatch_id: $dispatch_id,
              run_id: $run_id,
              run_attempt: $run_attempt,
              workflow: $workflow,
              repo: $repo,
              ref: $ref,
              sha: $sha,
              triggered_by: $triggered_by,
              ts_utc: $ts_utc,
              project_name: $project_name,
              project_label: $project_label,
              rpc: $rpc,
              report_type: $report_type,
              pulse: {
                attached: ($pulse_attached == "true"),
                tier: $pulse_tier,
                url: $pulse_url,
                error: $pulse_error
              },
              bundle: $bundle[0]
            }' > "$bundle_dir/bundle_inputs.json"

          echo "âœ… bundle_inputs.json ready: $bundle_dir/bundle_inputs.json"

      - name: Upload artifacts (debug)
        uses: actions/upload-artifact@v4
        with:
          name: ssa-bundle-${{ github.event_name }}-${{ github.run_id }}
          path: reports/
          if-no-files-found: error
          retention-days: 7

      - name: Commit & Push (force add reports for Base44 ingestion)
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "ssa-bot"
          git config user.email "ssa-bot@users.noreply.github.com"

          git add -f "reports/"

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "SSA BUNDLE: run ${{ github.run_id }} (${{ github.event_name }})"
          git push


















































